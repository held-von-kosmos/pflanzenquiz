<!-- Skript erstellt von Aaron Tholl in Visual Studio Code, Stand 2025-06-26 -->

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>🌱 Pflanzen des Universitätscampus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Build-Datum als Meta-Tag für Versionsinfo -->
    <meta name="build-date" content="2025-06-24">
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            margin: 0;
            background: #f7f7f7;
        }
        .banner {
            background: #e0f2e9;
            border-bottom: 2px solid #b2dfdb;
            padding: 1em 2em 1em 2em;
            z-index: 10;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        .banner-toggle {
            background: #b2dfdb;
            border: none;
            border-radius: 4px;
            padding: 0.6em 1em;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 3px;
            margin-left: 6px;
        }
        .banner-text {
            margin-top: 58px;
            margin-bottom: 20px;
        }
        .version-info {
            font-size: 0.85em;
            white-space: nowrap;
            margin-top: 3px;
            margin-right: 6px;
        }
        #versionInfoFixed {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 30;
            background: #b2dfdb;
            padding: 0em 1em;
            border-radius: 4px;
            line-height: 2.2em;
            height: 2.4em;
            display: flex;
            align-items: center;
        }
        #bannerToggle {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 20;
            display: block;
        }
        #showBannerBtn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 20;
            display: block;
        }
        .container {
            max-width: 1000px;
            margin: 13px auto 13px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            padding: 2em;
        }
        h1 {
            margin-top: 0;
        }
        h2 {
            font-size: 1.25em;
        }
        .quiz-controls {
            display: flex;
            gap: 1em;
            margin-bottom: 0;
            flex-wrap: wrap;
            margin-bottom: 2px;
        }
        .quiz-controls label {
            font-weight: 500;
        }
        .quiz-controls label span.sort-label,
        .quiz-controls label span.sort-label-list {
            font-size: 0.95em;
            font-weight: 500;
        }
        .quiz-controls select option {
            font-variant: small-caps;
        }
        .quiz-controls select,
        .quiz-controls button {
            padding: 0.3em 0.7em;
            font-size: 0.85em;
        }
        .quiz-page {
            display: flex;
            flex-direction: column;
            gap: 2em;
        }
        .plant-card {
            background: #f1f8e9;
            border-radius: 6px;
            padding: 1em 1.5em;
            box-shadow: 0 1px 4px #0001;
            display: flex;
            flex-direction: column;
            gap: 0.7em;
            font-size: 1em;
            margin-bottom: 2px;
        }
        .plant-images {
            display: flex;
            gap: 1em;
            flex-wrap: wrap;
        }
        .plant-images img {
            height: 300px;
            width: auto;
            max-width: 100%;
            border-radius: 4px;
            border: 1px solid #b2dfdb;
            background: #fff;
            object-fit: contain;
            aspect-ratio: auto;
        }
        .inputs-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1em;
            justify-content: flex-start;
            position: relative;
        }
        .inputs-row input {
            padding: 0.4em;
            font-size: 0.85em;
            border: 1px solid #b2dfdb;
            border-radius: 4px;
        }
        .solution-btn {
            margin-top: 0;
            margin-left: auto;
            background: #b2dfdb;
            border: none;
            border-radius: 4px;
            padding: 0.4em 1em;
            cursor: pointer;
            height: 2.4em;
            align-self: center;
        }
        .feedback {
            margin-top: 0.25em;
            font-weight: 500;
            font-size: 0.9em;
        }
        .solution {
            margin-top: 0.25em;
            font-size: 0.9em;
        }
        .nav-row {
            display: block;
            position: relative;
            align-items: center;
            text-align: center;
            justify-content: space-between;
            margin-top: 32px;
            margin-bottom: 12px;
        }
        .nav-row .nav-btn {
            position: absolute;
            min-width: 90px;
        }
        .nav-row .page-info {
            flex: 1 1 auto;
            margin: 0 1em;
            text-align: center;
        }
        .nav-row .nav-btn#backBtn,
        .nav-row .nav-btn#backBtnTop,
        .nav-row .nav-btn#backToQuizBtn {
            left: 0;
        }
        .nav-row .nav-btn#nextBtn,
        .nav-row .nav-btn#nextBtnTop,
        .nav-row .nav-btn#restartBtn {
            right: 0;
        }
        .nav-btn {
            background: #b2dfdb;
            border: none;
            border-radius: 4px;
            padding: 0.5em 1.2em;
            font-size: 0.85em;
            cursor: pointer;
        }
        .nav-btn:disabled {
            background: #e0e0e0;
            color: #aaa;
            cursor: not-allowed;
        }
        .page-info {
            font-size: 0.9em;
        }
        .stand-box {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 6px;
            padding: 1.2em 2em;
            text-align: center;
            font-size: 1em;
            margin-top: 42px;
        }
        .overview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 44px;
            font-size: 0.85em;
        }
        .overview-table th,
        .overview-table td {
            border: 1px solid #b2dfdb;
            padding: 0.5em 0.7em;
            text-align: left;
        }
        .overview-table th {
            background: #e0f2e9;
        }
        .overview-table tr:nth-child(even) {
            background: #f7f7f7;
        }
        .share-info {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #e8f5e9;
            border: 1px solid #b2dfdb;
            border-radius: 4px;
            padding: 0.2em 1em;
            font-size: 0.75em;
            color: #388e3c;
            box-shadow: 0 2px 8px #0001;
            z-index: 100;
            transition: opacity 0.5s;
            opacity: 1;
            text-align: center;
            min-width: 120px;
        }
        .scientific-name {
            font-style: italic;
        }
        .scientific-name .no-italic {
            font-style: normal !important;
            font-family: inherit !important;
        }
        .mobile-hyphen { 
            display: none; 
        }
        .mobile-break { 
            display: none; 
        }
        @media (max-width: 700px) {
            .plant-images img {
                height: 240px;
            }
            .inputs-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5em;
            }
            .inputs-row input, 
            .inputs-row button {
                width: 100%;
                box-sizing: border-box;
            }
            .share-info {
                font-size: 1em;
                padding: 0.3em 0.5em;
                margin-top: -2.75em;
            }
            .plant-card {
                padding: 0.75em 0.75em;
            }
            .container {
                overflow-x: auto;
            }
            .quiz-page {
                gap: 1em;
            }
            .overview-table {
                font-size: 0.85em;
                margin-top: 16px;
                width: max-content;
                min-width: 100vw;
                position: relative;
                width: 100% !important;
                min-width: 0 !important;
            }
            .nav-row {
                display: flex;
                flex-direction: row;
                align-items: stretch;
                margin-top: 30px;
                margin-bottom: 0;
            }
            .nav-row .nav-btn {
                width: 30vw;
                min-width: 90px;
                height: 3.5em;
                position: static;
                white-space: normal;
                align-items: center;
                margin-bottom: 16px;
            }
            .nav-row .page-info {
                flex: 1 1 auto;
                min-width: 0;
                text-align: center;
                width: auto;
                max-width: 40vw;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                white-space: pre-line;
                align-items: center;
            }
            .nav-row-bottom {
                margin-bottom: -16px;
            }
            .overview-nav-row .page-info {
                text-align: center;
                justify-content: flex-end;
                margin-top: 14px;
                margin-right: 36px;
            }
            .stand-box {
                margin-top: 16px;
            }
            .mobile-hyphen { 
                display: inline; 
            }
            .mobile-break::after {
                content: "\A";
                white-space: pre;
            }
            .mobile-break { 
                display: inline; 
            }
            .overview-container {
                position: relative;
                overflow: auto;
                background: #fff;
                box-sizing: content-box;
            }
            .overview-container::before {
                content: "";
                position: fixed;
                top: var(--overview-table-top, 0);
                left: 32px;
                width: 18px;
                height: var(--overview-table-height, 100px);
                pointer-events: none;
                border-left: 3px dashed #b2dfdb;
                z-index: 2;
                display: block;
                transition: opacity 0.2s;
                opacity: 1;
            }
            .overview-container.scrolled-start::before {
                opacity: 0;
            }
            .overview-container::after {
                content: "";
                position: fixed;
                top: var(--overview-table-top, 0);
                right: 32px;
                width: 18px;
                height: var(--overview-table-height, 100px);
                pointer-events: none;
                border-right: 3px dashed #b2dfdb;
                z-index: 2;
                display: block;
                transition: opacity 0.2s;
                opacity: 1;
            }
            .overview-container.scrolled-end::after {
                opacity: 0;
            }
            body.banner-hidden .container {
                margin-top: 0 !important;
            }
            #versionInfoFixed {
                position: static !important;
                margin-top: 13px;
                margin-right: 32px;
            }
            .top-bar-mobile {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
            }
            #bannerToggle,
            #showBannerBtn {
                position: static !important;
                float: none;
                margin-top: 13px;
                margin-bottom: 13px;
                margin-right: 32px;
            }
            .banner {
                padding-top: env(safe-area-inset-top, 0);
                margin-top: -200px;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
                border-top: none;
            }
            h1 {
                margin-top: 140px;
            }
            body {
                margin-top: 0 !important;
            }
            .versioninfo-spacer {
                display: none;
            }
        }
        @media (min-width: 701px) {
            body.banner-hidden .versioninfo-spacer {
                height: 46px;
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar-mobile">
        <div class="version-info" id="versionInfoFixed"></div>
        <button class="banner-toggle" id="bannerToggle" style="display:block;">Intro ausblenden</button>
        <button class="banner-toggle" id="showBannerBtn" style="display:none;">Intro einblenden</button>
    </div>
    <div class="versioninfo-spacer"></div>
    <div class="banner" id="banner">
        <div class="banner-text">
            <h1>Pflanzen des Universitätscampus Konstanz</h1>
            <h2>Arten aus dem Geländepraktikum 2025</h2>
                Nenne den <b>wissenschaftlichen <u><span style="font-variant: small-caps;">oder</span></u> den deutschen Namen</b> der folgenden Pflanzenarten sowie die dazugehörige Pflanzenfamilie.<br>
                Das Quiz ist in Runden mit jeweils 20 Pflanzenarten aufgeteilt. Am Ende jeder Runde kannst du die Anzahl der korrekt bestimmten Pflanzen sehen.<br><br>
                <i>
                    Taxonomie nach <a href="https://biologie.uni-konstanz.de/doerken/">Prof. Dr. Veit Martin Dörken</a> (Universität Konstanz) und dem <a href="https://www.floraweb.de/">Bundesamt für Naturschutz (BfN)</a>, 
                    Bilder von verschiedenen Urhebern auf <a href="https://www.pflanzenlernen.de/">Planta Go Lingo</a> sowie <a href="https://www.blumeninschwaben.de/">Flora-de</a>.<br>
                    Abweichende taxonomische Konzepte und Trivialnamen werden nicht berücksichtigt, diese können auf den genannten Websites eingesehen werden.<br>
                    Weitere Bilder und die wichtigsten Bestimmungsmerkmale findest du auf <a href="https://www.blumeninschwaben.de/">Flora-de</a>.
                </i>
        </div>
    </div>
    <div class="container" id="mainContainer">
        <div id="quizRoot"></div>
    </div>
    <script>
        // --- Hilfsfunktionen ---
        function shuffle(arr) {
            let a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        function normalize(str) {
            // Entferne Abkürzungen aus wissenschaftlichen Namen und Präfixe aus deutschen Namen
            return (str || '')
                // Entferne "agg.", "sect.", "subg." (wiss. Name)
                .replace(/\b(agg\.?|sect\.?|subg\.?)\b/gi, '')
                // Entferne "Artengruppe", "Sektion", "Untergattung", "Gattung" (dt. Name)
                .replace(/\b(Artengruppe|Sektion|Untergattung|Gattung)\b/gi, '')
                .toLowerCase()
                .replace(/[\s\-äöüß]/g, s => ({
                    'ä':'ae','ö':'oe','ü':'ue','ß':'ss',' ':'','-':''
                }[s]||s))
                .replace(/[^a-z]/g,'');
        }
        function isTypo(a, b) {
            // Levenshtein-Distanz <= 2
            if (!a || !b) return false;
            a = normalize(a); b = normalize(b);
            if (a === b) return false;
            let m = Array(a.length+1).fill().map(()=>Array(b.length+1).fill(0));
            for(let i=0;i<=a.length;i++)m[i][0]=i;
            for(let j=0;j<=b.length;j++)m[0][j]=j;
            for(let i=1;i<=a.length;i++)
                for(let j=1;j<=b.length;j++)
                    m[i][j]=a[i-1]==b[j-1]?m[i-1][j-1]:1+Math.min(m[i-1][j],m[i][j-1],m[i-1][j-1]);
            return m[a.length][b.length]<=2;
        }
        function saveState(key, value) {
            try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
        }
        function loadState(key, fallback) {
            try {
                let v = localStorage.getItem(key);
                return v ? JSON.parse(v) : fallback;
            } catch { return fallback; }
        }
        // Hilfsfunktion zum Formatieren der wissenschaftlichen Namen
        function formatScientificName(name) {
            const abbrPattern = /^(agg\.?|sect\.?|subg\.?)$/i;
            return name
                .split(/\s+/)
                .map(word => abbrPattern.test(word) ? `<span class="no-italic">${word}</span>` : `<i>${word}</i>`)
                .join(' ');
        }
        // --- Banner-Logik ---
        const banner = document.getElementById('banner');
        const bannerToggle = document.getElementById('bannerToggle');
        const showBannerBtn = document.getElementById('showBannerBtn');
        const versionInfoFixed = document.getElementById('versionInfoFixed');

        // Banner-Status aus Storage laden, aber nach 1 Tag automatisch wieder einblenden
        function getBannerHidden() {
            const obj = JSON.parse(localStorage.getItem('pflanzenquiz_banner_hidden') || 'false');
            // Prüfe, ob ein Zeitstempel gespeichert ist
            if (typeof obj === 'object' && obj !== null && 'hidden' in obj && 'ts' in obj) {
                // 1 Tag (in ms)
                if (Date.now() - obj.ts > 1 * 24 * 60 * 60 * 1000) {
                    return false; // Nach 1 Tag wieder einblenden
                }
                return obj.hidden;
            }
            // Altes Format (nur true/false)
            return obj;
        }
        function saveBannerHidden(hidden) {
            localStorage.setItem('pflanzenquiz_banner_hidden', JSON.stringify({hidden, ts: Date.now()}));
        }

        let bannerHidden = getBannerHidden();

        window.updateDashedBorder = function() {
            // Sucht die Übersichtstabelle und aktualisiert die Linie, falls vorhanden
            const container = document.querySelector('.overview-container');
            const table = container ? container.querySelector('.overview-table') : null;
            if (!container || !table) return;
            // Prüfe, ob ganz nach rechts gescrollt wurde
            if (container.scrollWidth - container.scrollLeft - container.clientWidth < 2) {
                container.classList.add('scrolled-end');
            } else {
                container.classList.remove('scrolled-end');
            }
            // Links
            if (container.scrollLeft < 2) {
                container.classList.add('scrolled-start');
            } else {
                container.classList.remove('scrolled-start');
            }
            // Höhe und Top-Position der Linie setzen
            const rect = table.getBoundingClientRect();
            document.documentElement.style.setProperty('--overview-table-top', rect.top + 'px');
            document.documentElement.style.setProperty('--overview-table-height', rect.height + 'px');
        };

        function updateBanner() {
            banner.style.display = bannerHidden ? 'none' : '';
            bannerToggle.style.display = bannerHidden ? 'none' : 'block';
            showBannerBtn.style.display = bannerHidden ? 'block' : 'none';
            // Klasse für mehr Abstand oben, wenn Banner eingeklappt ist
            if (bannerHidden) {
                document.body.classList.add('banner-hidden');
            } else {
                document.body.classList.remove('banner-hidden');
            }
            setTimeout(() => window.updateDashedBorder(), 0);
        }
        bannerToggle.onclick = () => {
            bannerHidden = !bannerHidden;
            saveBannerHidden(bannerHidden);
            updateBanner();
        };
        showBannerBtn.onclick = () => {
            bannerHidden = false;
            saveBannerHidden(bannerHidden);
            updateBanner();
        };
        updateBanner();

        // --- Banner per Taste I ein-/ausblenden ---
        window.addEventListener('keydown', function(e) {
            // Nur wenn KEIN Eingabefeld fokussiert ist
            const active = document.activeElement;
            if (
                e.key.toLowerCase() === 'i' &&
                !(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable))
            ) {
                e.preventDefault();
                bannerHidden = !bannerHidden;
                saveBannerHidden(bannerHidden);
                updateBanner();
            }
        });

        // --- Version Info ---
        function updateVersionInfo() {
            // Datum aus <meta name="build-date">
            let codeDate = document.querySelector('meta[name="build-date"]')?.content || 'unbekannt';
            let info = `Zuletzt aktualisiert: ${codeDate} | ${plants.length} Pflanzen | ${allRounds.length} Runden`;
            versionInfoFixed.textContent = info;
        }

        // --- Daten laden ---
        let plants = [];
        localStorage.removeItem('pflanzenquiz_state');
        let quizState = {};
        let sortMode = quizState.sortMode || 'scientific';
        let overviewMode = false;
        let overviewReturnToSummary = false;
        let allRounds = [];
        let currentRound = 0;
        let currentPage = 0;
        let plantsPerRound = 20;
        let plantsPerPage = 5;
        let totalCorrect = 0;

        // --- Quiz-Logik ---
        function renderQuiz() {
            // Fokus und Cursorposition merken
            const active = document.activeElement;
            let focusInfo = null;
            if (active && active.classList && (active.classList.contains('input-scientific') || active.classList.contains('input-german') || active.classList.contains('input-family'))) {
                focusInfo = {
                    className: active.className,
                    value: active.value,
                    selectionStart: active.selectionStart,
                    selectionEnd: active.selectionEnd,
                    parentPid: active.closest('.plant-card')?.dataset.pid
                };
            }

            const root = document.getElementById('quizRoot');
            if (overviewMode) {
                renderSummary(root);
                return;
            }
            // Runden und Seiten berechnen
            let roundPlants = allRounds[currentRound];
            let pageCount = Math.ceil(roundPlants.length / plantsPerPage);
            let pagePlants = roundPlants.slice(currentPage * plantsPerPage, (currentPage + 1) * plantsPerPage);

            // Quiz Controls
            let resetBtnText = (sortMode === 'random') ? 'Quiz zurücksetzen (neu mischen)' : 'Quiz zurücksetzen';
            let controlsHtml = `
            <div class="quiz-controls">
                <label><span class="sort-label">Sortierung:</span>
                    <select id="sortSelect">
                        <option value="random">Zufällig</option>
                        <option value="scientific">Wissenschaftlicher Name</option>
                        <option value="german">Deutscher Name</option>
                        <option value="family">Familie (wiss.)</option>
                        <option value="family_german">Familie (dt.)</option>
                    </select>
                </label>
                <button id="overviewBtn">Pflanzenübersicht</button>
                <button id="resetQuizBtn">${resetBtnText}</button>
            </div>
            `;

            // Quiz-Seite
            let html = controlsHtml + `<div class="quiz-page">`;

            // Navigation oben
            html += `
            <div class="nav-row">
                <button class="nav-btn" id="backBtnTop" ${currentPage===0&&currentRound===0?'disabled':''}>Zurück</button>
                <span class="page-info">Seite ${currentPage+1} von ${pageCount} (Runde ${currentRound+1})</span>
                <button class="nav-btn" id="nextBtnTop" ${currentPage===pageCount-1?'':'enabled'}>${currentPage===pageCount-1?'Runde abschließen':'Weiter'}</button>
            </div>
            `;

            pagePlants.forEach((plant, idx) => {
                let pid = plant._id;
                let state = quizState.answers?.[pid] || {};
                let showSolution = !!state.showSolution;
                let feedback = state.feedback || '';
                let feedbackClass = feedback.startsWith('✅') ? 'correct'
                    : feedback.startsWith('❌') ? 'incorrect'
                    : feedback.startsWith('⚠️') ? (feedback.includes('Tippfehler') ? 'typo' : 'partial')
                    : '';
                let anyInput = (state.scientific || state.german || state.family) ? true : false;
                let dirty = !!state.dirty;
                // Button-Text je nach Zustand
                let btnText = '';
                if (!anyInput) {
                    btnText = showSolution ? 'Lösung verbergen' : 'Lösung aufdecken';
                } else if (showSolution && state.showFeedback && dirty) {
                    btnText = 'Antwort erneut überprüfen';
                } else if (!showSolution || dirty) {
                    btnText = 'Antwort überprüfen';
                } else {
                    btnText = 'Lösung verbergen';
                }
                // Nummer berechnen (global über alle Runden)
                let plantNumber = currentRound * plantsPerRound + currentPage * plantsPerPage + idx + 1;
                html += `
                <div class="plant-card" data-pid="${pid}">
                    <div style="font-weight:bold;">
                        Pflanze ${plantNumber}
                    </div>
                    <div class="plant-images">
                        ${plant.images.map(img => `<img src="images/${img}" alt="Bild von ${plant.scientific}">`).join('')}
                    </div>
                    <div class="inputs-row">
                        <input type="text" placeholder="Wissenschaftlicher Name" class="input-scientific" value="${state.scientific||''}">
                        <input type="text" placeholder="Deutscher Name" class="input-german" value="${state.german||''}">
                        <input type="text" placeholder="Familie" class="input-family" value="${state.family||''}">
                        <button class="solution-btn">${btnText}</button>
                    </div>
                    ${
                        showSolution && state.showFeedback && anyInput
                            ? `<div class="feedback ${feedbackClass}">${state.feedback}</div>`
                            : (showSolution && !anyInput
                                ? `<div class="solution">${solutionText(plant)}</div>`
                                : '')
                    }
                </div>
                `;
            });
            html += `</div>`;

            // Navigation
            html += `
            <div class="nav-row nav-row-bottom">
                <button class="nav-btn" id="backBtn" ${currentPage===0&&currentRound===0?'disabled':''}>Zurück</button>
                <span class="page-info">Seite ${currentPage+1} von ${pageCount} (Runde ${currentRound+1})</span>
                <button class="nav-btn" id="nextBtn" ${currentPage===pageCount-1?'':'enabled'}>${currentPage===pageCount-1?'Runde abschließen':'Weiter'}</button>
            </div>
            `;

            // Zwischenstand-Seite zwischen den Runden
            if (
                !overviewMode &&
                currentPage === 0 &&
                currentRound > 0 &&
                quizState.roundResults?.[currentRound - 1] &&
                quizState.showInterRound
            ) {
                let prevRound = currentRound - 1;
                let roundCorrect = quizState.roundResults[prevRound].correct;
                let roundTotal = allRounds[prevRound].length;
                let html = `
                    <div class="quiz-controls">
                        <button id="overviewBtn">Pflanzenübersicht</button>
                        <button id="resetQuizBtn">Quiz zurücksetzen</button>
                    </div>
                    <div class="nav-row">
                        <button class="nav-btn" id="backBtnTop">Zurück</button>
                        <span class="page-info">Dein Fortschritt</span>
                        <button class="nav-btn" id="nextBtnTop">Nächste Runde</button>
                    </div>
                    <div class="stand-box">
                        <strong>Zwischenstand Runde ${prevRound + 1}</strong><br>
                        Du hast in dieser Runde ${roundCorrect} von ${roundTotal} Pflanzen korrekt identifiziert.<br>
                        Gesamt korrekt: ${quizState.totalCorrect} von ${plants.length}
                    </div>
                `;
                document.getElementById('quizRoot').innerHTML = html;

                // Controls-Events für Übersicht und Reset
                document.getElementById('overviewBtn').onclick = () => {
                    overviewMode = true;
                    renderOverview(document.getElementById('quizRoot'));
                };
                document.getElementById('resetQuizBtn').onclick = () => {
                    quizState = { sortMode }; // sortMode beibehalten!
                    overviewMode = false;
                    setupRounds();
                    currentRound = 0;
                    currentPage = 0;
                    saveState('pflanzenquiz_state', quizState);
                    renderQuiz();
                };

                // Navigation-Events für Zwischenstand-Seite
                document.getElementById('backBtnTop').onclick = () => {
                    quizState.showInterRound = false;
                    currentRound--;
                    currentPage = Math.ceil(allRounds[currentRound].length / plantsPerPage) - 1;
                    renderQuiz();
                };
                document.getElementById('nextBtnTop').onclick = () => {
                    quizState.showInterRound = false;
                    renderQuiz();
                };

                // Pfeiltasten-Navigation auch auf der Zusammenfassungs-Seite
                window.onkeydown = e => {
                    if (e.target.tagName === 'INPUT') return;
                    if (e.key === 'ArrowLeft') document.getElementById('backBtnTop').click();
                    if (e.key === 'ArrowRight') document.getElementById('nextBtnTop').click();
                };

                return;
            }

            root.innerHTML = html;

            // Nach dem Rendern: Fokus wiederherstellen
            if (focusInfo) {
                const selector = `.plant-card[data-pid="${focusInfo.parentPid}"] .${focusInfo.className.split(' ').join('.')}`;
                const input = document.querySelector(selector);
                if (input) {
                    input.focus();
                    // Cursorposition wiederherstellen
                    input.setSelectionRange(focusInfo.selectionStart, focusInfo.selectionEnd);
                }
            }

            // Controls-Events
            if (document.getElementById('sortSelect')) {
                document.getElementById('sortSelect').value = sortMode;
                document.getElementById('sortSelect').onchange = e => {
                    sortMode = e.target.value;
                    quizState.sortMode = sortMode;
                    saveState('pflanzenquiz_state', quizState);
                    setupRounds();
                    currentRound = 0; currentPage = 0;
                    renderQuiz();
                };
            }
            document.getElementById('overviewBtn').onclick = () => {
                overviewMode = true;
                renderOverview(document.getElementById('quizRoot'));
            };
            document.getElementById('resetQuizBtn').onclick = () => {
                quizState = { sortMode }; // sortMode beibehalten!
                overviewMode = false;
                setupRounds();
                currentRound = 0;
                currentPage = 0;
                saveState('pflanzenquiz_state', quizState);
                renderQuiz();
            };

            // Navigation
            document.getElementById('backBtn').onclick = () => {
                savePageInputs();
                if (currentPage > 0) currentPage--;
                else if (currentRound > 0) { 
                    currentRound--; 
                    currentPage = Math.ceil(allRounds[currentRound].length/plantsPerPage)-1; 
                }
                renderQuiz();
            };
            document.getElementById('nextBtn').onclick = () => {
                savePageInputs();
                if (currentPage < pageCount-1) {
                    currentPage++;
                    renderQuiz();
                } else {
                    // Runde abschließen: gehe zur Zwischenstand-Seite oder zur Gesamtzusammenfassung
                    let roundCorrect = countRoundCorrect(currentRound);
                    quizState.roundResults = quizState.roundResults || {};
                    quizState.roundResults[currentRound] = { correct: roundCorrect };
                    quizState.totalCorrect = countTotalCorrect();
                    saveState('pflanzenquiz_state', quizState);

                    if (currentRound < allRounds.length - 1) {
                        // Zwischenstand-Seite aktivieren
                        quizState.showInterRound = true;
                        currentRound++;
                        currentPage = 0;
                        renderQuiz();
                    } else {
                        // Letzte Runde: Zeige die Gesamtzusammenfassung!
                        overviewMode = true;
                        renderSummary(document.getElementById('quizRoot'));
                    }
                }
            };
            // Navigation oben (Buttons verhalten sich identisch)
            document.getElementById('backBtnTop').onclick = () => {
                if (
                    currentPage === 0 &&
                    currentRound > 0 &&
                    !overviewMode &&
                    !quizState.showInterRound
                ) {
                    // Gehe zur Zwischenstandsseite der vorherigen Runde
                    quizState.showInterRound = true;
                    renderQuiz();
                    return;
                }
                // Standardverhalten
                savePageInputs();
                if (currentPage > 0) currentPage--;
                else if (currentRound > 0) { 
                    currentRound--; 
                    currentPage = Math.ceil(allRounds[currentRound].length/plantsPerPage)-1; 
                }
                renderQuiz();
            };
            document.getElementById('backBtn').onclick = document.getElementById('backBtnTop').onclick;

            document.getElementById('nextBtnTop').onclick = document.getElementById('nextBtn').onclick;

            // Pfeiltasten
            window.onkeydown = e => {
                if (e.target.tagName === 'INPUT') return;
                if (e.key === 'ArrowLeft') document.getElementById('backBtn').click();
                if (e.key === 'ArrowRight') document.getElementById('nextBtn').click();
            };

            // Eingaben & Lösungsknöpfe
            document.querySelectorAll('.plant-card').forEach(card => {
                let pid = card.dataset.pid;
                let sci = card.querySelector('.input-scientific');
                let ger = card.querySelector('.input-german');
                let fam = card.querySelector('.input-family');
                let btn = card.querySelector('.solution-btn');
                sci.oninput = ger.oninput = fam.oninput = () => {
                    let val = {
                        scientific: sci.value,
                        german: ger.value,
                        family: fam.value
                    };
                    quizState.answers = quizState.answers || {};
                    let prevState = quizState.answers[pid] || {};
                    quizState.answers[pid] = Object.assign({}, prevState, val);

                    if (!val.scientific && !val.german && !val.family) {
                        quizState.answers[pid].showSolution = false;
                        quizState.answers[pid].showFeedback = false;
                        quizState.answers[pid].feedback = '';
                        quizState.answers[pid].dirty = false;
                    } else {
                        // Wenn Feedback angezeigt wird, dirty setzen, Feedback aber NICHT neu berechnen!
                        if (quizState.answers[pid].showSolution && quizState.answers[pid].showFeedback) {
                            quizState.answers[pid].dirty = true;
                            // Feedback bleibt stehen!
                        } else {
                            // Sonst wie gehabt
                            quizState.answers[pid].dirty = true;
                        }
                    }
                    saveState('pflanzenquiz_state', quizState);
                };
                btn.onclick = () => {
                    quizState.answers = quizState.answers || {};
                    quizState.answers[pid] = quizState.answers[pid] || {};
                    let state = quizState.answers[pid];
                    let anyInput = (state.scientific || state.german || state.family) ? true : false;
                    if (!anyInput) {
                        state.showSolution = !state.showSolution;
                        state.showFeedback = false;
                        state.feedback = '';
                        state.dirty = false;
                    } else if (!state.showSolution || state.dirty) {
                        // Antwort überprüfen oder erneut überprüfen
                        state.showSolution = true;
                        state.showFeedback = true;
                        state.feedback = checkAnswer(plants.find(p=>p._id==pid), state);
                        state.dirty = false;
                    } else {
                        // Lösung verbergen
                        state.showSolution = false;
                        state.showFeedback = false;
                        state.feedback = '';
                        state.dirty = false;
                    }
                    saveState('pflanzenquiz_state', quizState);
                    renderQuiz();
                };
            });
        }

        function savePageInputs() {
            // Alle Eingaben auf der Seite speichern (bereits live, aber redundanzsicher)
            document.querySelectorAll('.plant-card').forEach(card => {
                let pid = card.dataset.pid;
                let sci = card.querySelector('.input-scientific').value;
                let ger = card.querySelector('.input-german').value;
                let fam = card.querySelector('.input-family').value;
                quizState.answers = quizState.answers || {};
                quizState.answers[pid] = Object.assign(quizState.answers[pid]||{}, {
                    scientific: sci, german: ger, family: fam
                });
            });
            saveState('pflanzenquiz_state', quizState);
        }

        function checkAnswer(plant, input) {
            let sci = normalize(input.scientific);
            let ger = normalize(input.german);
            let fam = normalize(input.family);
            let fams = [normalize(plant.family), ...(plant.family_german||[]).map(normalize)];
            let sciOk = sci && normalize(plant.scientific) === sci;
            let gerOk = ger && normalize(plant.german) === ger;
            let famOk = fam && fams.includes(fam);

            // Tippfehler?
            let sciTypo = sci && isTypo(input.scientific, plant.scientific);
            let gerTypo = ger && isTypo(input.german, plant.german);
            let famTypo = fam && fams.some(f => isTypo(input.family, f));

            // Nur ein Feld ausgefüllt → Hinweis, egal ob richtig oder falsch
            if (((sci || ger) && !fam)) {
                return `⚠️ Bitte gib zusätzlich zum Artnamen auch die <b>Pflanzenfamilie</b> an.`;
            }
            if ((fam && !(sci || ger))) {
                return `⚠️ Bitte gib zusätzlich zur Pflanzenfamilie auch den <b>Artnamen</b> an.`;
            }

            // Teilweise richtig: Name 1 stimmt, Familie stimmt, Name 2 ist falsch oder hat einen Tippfehler
            if (famOk && (
                    (sciOk && ger && (!gerOk || gerTypo)) ||
                    (gerOk && sci && (!sciOk || sciTypo))
                )) {
                return `☑️ Teilweise richtig! Die Pflanze heißt: <b><span class="scientific-name">${formatScientificName(plant.scientific)}</span> (${plant.german}), ${plant.family} (${(plant.family_german||[]).join(', ')})</b>`;
            }

            // Richtig: Name 1 oder 2 oder beide stimmen, Familie stimmt, Name 2 ist korrekt oder leer
            if (famOk && (
                    (sciOk && (!ger || gerOk)) ||
                    (gerOk && (!sci || sciOk)))) {
                return `✅ Richtig! Die Pflanze heißt: <b><span class="scientific-name">${formatScientificName(plant.scientific)}</span> (${plant.german}), ${plant.family} (${(plant.family_german||[]).join(', ')})</b>`;
            }

            // Tippfehler: Namen oder Familie oder beide enthalten Tippfehler
            if (((sciTypo || gerTypo) && famOk) ||
                ((sciOk || gerOk) && famTypo) ||
                ((sciTypo || gerTypo) && famTypo)) {
                return `⚠️ Fast richtig! <b>(Tippfehler?)</b>`;
            }

            // Falsch: Kein Name oder Familie stimmt
            if (sci || ger || fam) {
                return `❌ Falsch! Richtig wäre: <b><span class="scientific-name">${formatScientificName(plant.scientific)}</span> (${plant.german}), ${plant.family} (${(plant.family_german||[]).join(', ')})</b>`;
            }
            return '';
        }

        function solutionText(plant) {
            return `ℹ️ Die Pflanze heißt: <b><span class="scientific-name">${formatScientificName(plant.scientific)}</span> (${plant.german}), ${plant.family} (${(plant.family_german||[]).join(', ')})</b>`;
        }

        function countRoundCorrect(roundIdx) {
            let round = allRounds[roundIdx];
            let count = 0;
            round.forEach(plant => {
                let ans = quizState.answers?.[plant._id];
                if (!ans) return;
                let fb = checkAnswer(plant, ans);
                if (fb.startsWith('✅') || fb.startsWith('☑️')) count++;
            });
            return count;
        }
        function countTotalCorrect() {
            let count = 0;
            plants.forEach(plant => {
                let ans = quizState.answers?.[plant._id];
                if (!ans) return;
                let fb = checkAnswer(plant, ans);
                if (fb.startsWith('✅') || fb.startsWith('☑️')) count++;
            });
            return count;
        }

        // --- Übersicht ---
        function renderOverview(root) {
            // Eigener Sortiermodus für die Übersicht (unabhängig vom Quiz)
            let overviewSortMode = window.overviewSortMode || 'scientific';

            let sortedPlants = plants.slice();
            if (overviewSortMode === 'scientific') sortedPlants.sort((a, b) => a.scientific.localeCompare(b.scientific));
            else if (overviewSortMode === 'german') sortedPlants.sort((a, b) => a.german.localeCompare(b.german));
            else if (overviewSortMode === 'family') sortedPlants.sort((a, b) => a.family.localeCompare(b.family));
            else if (overviewSortMode === 'family_german') {
                sortedPlants.sort((a, b) => {
                    let famA = (a.family_german && a.family_german.length) ? a.family_german[0] : '';
                    let famB = (b.family_german && b.family_german.length) ? b.family_german[0] : '';
                    return famA.localeCompare(famB);
                });
            }

            let html = `
                <div class="quiz-controls">
                    <label><span class="sort-label-list">Sortierung der Pflanzenliste:</span>
                        <select id="sortSelectOverview">
                            <option value="scientific">Wissenschaftlicher Name</option>
                            <option value="german">Deutscher Name</option>
                            <option value="family">Familie (wiss.)</option>
                            <option value="family_german">Familie (dt.)</option>
                        </select>
                    </label>
                </div>
                <div class="nav-row overview-nav-row">
                    <button class="nav-btn" id="backToQuizBtn" style="left:0;right:auto;">Zurück</button>
                    <span class="page-info">Pflanzenübersicht</span>
                </div>
                <div class="overview-container">
                    <table class="overview-table">
                        <tr>
                            <th>#</th>
                            <th>Wissenschaftlicher Name</th>
                            <th>Deutscher Name</th>
                            <th>Familie (wiss.)</th>
                            <th>Familie (dt.)</th>
                        </tr>
                        ${sortedPlants.map((p,i)=>`
                            <tr>
                                <td>${i+1}</td>
                                <td><span class="scientific-name">${formatScientificName(p.scientific)}</span></td>
                                <td>${p.german}</td>
                                <td>${p.family}</td>
                                <td>${(p.family_german||[]).join(', ')}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
            root.innerHTML = html;

            // Sortierauswahl setzen und Event-Handler
            const select = document.getElementById('sortSelectOverview');
            select.value = overviewSortMode;
            select.onchange = e => {
                window.overviewSortMode = e.target.value;
                renderOverview(root);
            };

            document.getElementById('backToQuizBtn').onclick = () => {
                if (overviewReturnToSummary) {
                    overviewReturnToSummary = false;
                    renderSummary(document.getElementById('quizRoot'));
                } else {
                    overviewMode = false;
                    renderQuiz();
                }
            };

            const container = document.querySelector('.overview-container');
            const table = container.querySelector('.overview-table');

            function updateDashedBorder() {
                if (!container || !table) return;
                // Prüfe, ob ganz nach rechts gescrollt wurde
                if (container.scrollWidth - container.scrollLeft - container.clientWidth < 2) {
                    container.classList.add('scrolled-end');
                } else {
                    container.classList.remove('scrolled-end');
                }
                // Links
                if (container.scrollLeft < 2) {
                    container.classList.add('scrolled-start');
                } else {
                    container.classList.remove('scrolled-start');
                }
                // Höhe und Top-Position der Linie setzen
                const rect = table.getBoundingClientRect();
                document.documentElement.style.setProperty('--overview-table-top', rect.top + 'px');
                document.documentElement.style.setProperty('--overview-table-height', rect.height + 'px');
            }
            container.addEventListener('scroll', updateDashedBorder);
            window.addEventListener('resize', updateDashedBorder);
            window.addEventListener('scroll', updateDashedBorder);
            window.updateDashedBorder = updateDashedBorder;
            updateDashedBorder();

            window.onkeydown = function(e) {
                if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable)) return;
                if (e.key === 'ArrowLeft') {
                    document.getElementById('backToQuizBtn').click();
                }
            };
        }

        // --- Gesamtzusammenfassung ---
        function renderSummary(root) {
            // Korrekte pro Runde berechnen
            let summaryRows = allRounds.map((round, i) => {
                let correct = quizState.roundResults?.[i]?.correct ?? 0;
                return `<tr>
                    <td>${i+1}</td>
                    <td>${correct} / ${round.length}</td>
                </tr>`;
            }).join('');
            let total = quizState.totalCorrect || 0;
            let totalPlants = plants.length;

            // Teilen-Text
            let shareText = `Ich habe beim Pflanzenquiz ${total} von ${totalPlants} Arten korrekt bestimmt! 🌱`;
            let shareUrl = "https://kurzly.de/pflanzen";
            let shareData = {
                title: 'Pflanzenquiz-Ergebnis',
                text: shareText,
                url: shareUrl
            };

            let html = `
                <div class="quiz-controls">
                    <button id="overviewBtn">Pflanzenübersicht</button>
                </div>
                <div class="nav-row">
                    <button class="nav-btn" id="backToQuizBtn" style="left:0;right:auto;">Zurück</button>
                    <span class="page-info">Gesamt<span class="mobile-hyphen">-</span><span class="mobile-break"></span>ergebnis</span>
                    <button class="nav-btn" id="restartBtn" style="right:0;left:auto;">Quiz neu starten</button>
                </div>
                <div class="stand-box">
                    <b>Du hast insgesamt ${total} von ${totalPlants} Pflanzen korrekt identifiziert!</b>
                </div>
                <table class="overview-table" style="max-width:400px;margin:2em auto;">
                    <tr>
                        <th>Runde</th>
                        <th>Korrekt</th>
                    </tr>
                    ${summaryRows}
                </table>
                <div style="text-align:center;margin:2em 0;position:relative;">
                    <button class="nav-btn" id="shareBtn" type="button">Ergebnis teilen</button>
                </div>
            `;
            root.innerHTML = html;

            // Event-Handler:
            document.getElementById('backToQuizBtn').onclick = () => {
                overviewMode = false;
                renderQuiz();
            };
            document.getElementById('overviewBtn').onclick = () => {
                overviewMode = true;
                overviewReturnToSummary = true;
                renderOverview(document.getElementById('quizRoot'));
            };
            document.getElementById('restartBtn').onclick = () => {
                quizState = { sortMode }; // sortMode beibehalten!
                overviewMode = false;
                setupRounds();
                currentRound = 0;
                currentPage = 0;
                saveState('pflanzenquiz_state', quizState);
                renderQuiz();
            };
            // Event-Handler für Teilen-Button:
            document.getElementById('shareBtn').onclick = async () => {
                let oldInfo = document.getElementById('shareInfo');
                if (oldInfo) oldInfo.remove();
                let infoText = '';
                let success = false;
                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                        success = true;
                    } catch (e) {
                        infoText = 'Teilen abgebrochen oder nicht möglich.';
                    }
                } else if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
                        infoText = 'Link zum Ergebnis wurde in die Zwischenablage kopiert.';
                        success = true;
                    } catch {
                        infoText = 'Kopieren in die Zwischenablage nicht möglich.';
                    }
                } else {
                    // Fallback: Text in ein Prompt zum manuellen Kopieren anzeigen
                    window.prompt('Teile dein Ergebnis:\nKopiere den folgenden Text:', `${shareText}\n${shareUrl}`);
                    infoText = 'Du kannst den Link jetzt manuell kopieren.';
                    success = true;
                }
                // Info anzeigen, wenn sinnvoll
                if (infoText) {
                    const btn = document.getElementById('shareBtn');
                    const info = document.createElement('div');
                    info.id = 'shareInfo';
                    info.className = 'share-info';
                    info.textContent = infoText;
                    info.style.top = (btn.offsetTop + btn.offsetHeight + 6) + 'px';
                    const btnContainer = btn.parentElement;
                    btnContainer.style.position = 'relative';
                    btnContainer.appendChild(info);
                    setTimeout(() => {
                        info.style.opacity = '0';
                        setTimeout(() => info.remove(), 700);
                    }, success ? 2200 : 3500);
                }
            };
            // Pfeiltasten-Navigation
            window.onkeydown = e => {
                if (e.target.tagName === 'INPUT') return;
                if (e.key === 'ArrowLeft') {
                    const btn = document.getElementById('backToQuizBtn');
                    if (btn) btn.click();
                }
            };
        }

        // --- Runden vorbereiten ---
        function setupRounds() {
            let sorted;
            if (sortMode === 'scientific') sorted = plants.slice().sort((a,b)=>a.scientific.localeCompare(b.scientific));
            else if (sortMode === 'german') sorted = plants.slice().sort((a,b)=>a.german.localeCompare(b.scientific));
            else if (sortMode === 'family') sorted = plants.slice().sort((a,b)=>a.family.localeCompare(b.scientific));
            else if (sortMode === 'family_german') {
                sorted = plants.slice().sort((a, b) => {
                    let famA = (a.family_german && a.family_german.length) ? a.family_german[0] : '';
                    let famB = (b.family_german && b.family_german.length) ? b.family_german[0] : '';
                    return famA.localeCompare(famB);
                });
            }
            else sorted = shuffle(plants);
            allRounds = [];
            for (let i=0; i<sorted.length; i+=plantsPerRound) {
                allRounds.push(sorted.slice(i, i+plantsPerRound));
            }
        }

        // --- Daten laden und Initialisierung ---
        fetch('plants.json')
            .then(r=>r.json())
            .then(data=>{
                plants = data.map((p,i)=>Object.assign({_id:i},p));
                setupRounds();
                updateVersionInfo();
                renderQuiz();
            })
            .catch(e=>{
                document.getElementById('quizRoot').innerHTML = '<div style="color:red">Fehler beim Laden der Pflanzenliste.</div>';
            });

        window.addEventListener('keydown', function(e) {
            // ENTER-Taste
            if (e.key === 'Enter') {
                const active = document.activeElement;
                // Prüfe, ob ein Eingabefeld (auf der Quiz-Seite) fokussiert ist
                if (
                    active &&
                    active.classList &&
                    (active.classList.contains('input-scientific') ||
                     active.classList.contains('input-german') ||
                     active.classList.contains('input-family'))
                ) {
                    // Finde zugehörigen Button in der gleichen plant-card
                    const card = active.closest('.plant-card');
                    if (card) {
                        const btn = card.querySelector('.solution-btn');
                        if (btn) {
                            btn.click();
                            e.preventDefault();
                        }
                    }
                } else {
                    // Kein Eingabefeld fokussiert: alle Lösungsknöpfe auf der Seite betätigen
                    const cards = document.querySelectorAll('.plant-card');
                    if (!cards.length) return;

                    // Prüfe, ob ALLE Lösungen aufgedeckt sind (showSolution==true)
                    const allShown = Array.from(cards).every(card => {
                        const pid = card.dataset.pid;
                        const state = window.quizState?.answers?.[pid];
                        return state && state.showSolution;
                    });

                    cards.forEach(card => {
                        const btn = card.querySelector('.solution-btn');
                        const pid = card.dataset.pid;
                        const state = window.quizState?.answers?.[pid];
                        if (btn) {
                            // Wenn alle aufgedeckt: verbergen, sonst aufdecken
                            if (allShown && state && state.showSolution) {
                                btn.click();
                            } else if (!allShown && (!state || !state.showSolution)) {
                                btn.click();
                            }
                        }
                    });
                    e.preventDefault();
                }
            }
        });
    </script>
</body>
</html>